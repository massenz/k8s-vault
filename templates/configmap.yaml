# Autogenerated with:
#  kubectl create configmap vault-config --from-file=scripts --dry-run -o yaml >templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: {{ .Values.namespace }}
data:
  extraconfig-from-values.hcl: |
    disable_mlock = true
    ui = true

    listener "tcp" {
      tls_disable = 1
      address = "[::]:8200"
      cluster_address = "[::]:8201"
    }
    storage "file" {
      path = "/vault/data"
    }
  setup.sh: |
    #!/usr/bin/env sh
    set -eu
    echo "Enabling Kubernetes Authorization Policies"
    vault auth enable kubernetes

    echo "Creating KV Store for secrets/ path"
    vault secrets enable -version=2 -path="secrets" kv

    echo "Enabling Vault server to make API calls to Kubernetes"
    vault write auth/kubernetes/config \
        token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
        kubernetes_host="https://${KUBERNETES_PORT_443_TCP_ADDR}:443" \
        kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
        disable_iss_validation=true

    # Create a policy to enable access to secrets stored
    # in the KV store we just created.
    cat >/tmp/policy <<EOF
    path "secrets/*"
    {
        capabilities = [ "read" ]
    }
    EOF

    vault policy write secrets-policy /tmp/policy

    vault write auth/kubernetes/role/app \
        bound_service_account_names=vault-auth \
        bound_service_account_namespaces=vault \
        policies=secrets-policy \
        ttl=72h

    echo "Enabled the secretes-policy Policy in Vault:"
    vault policy read secrets-policy
  unseal.sh: |
    #!/usr/bin/env sh
    set -eu

    echo "Initializing Vault"
    vault operator init -key-shares=1 -key-threshold=1 -format=json > /vault/keys.json

    VAULT_UNSEAL_KEY=$(cat /vault/keys.json | jq -r ".unseal_keys_b64[]")
    VAULT_ROOT_KEY=$(cat /vault/keys.json | jq -r ".root_token")

    echo "Unsealing Vault"
    vault operator unseal $VAULT_UNSEAL_KEY
    VAULT_TOKEN=$(vault login $VAULT_ROOT_KEY | egrep "^token\s" | awk '{print $2}')

    echo "To login to Vault UI use http://localhost:32000 and Token: ${VAULT_TOKEN}"
